<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Audio with Mouth Cues</title>
    </head>
    <body>
        <a-scene embedded arjs>
            <a-marker preset="hiro">
                <a-box position="0 0.5 0" material="color: yellow;"></a-box>
            </a-marker>
            <a-entity camera></a-entity>
        </a-scene>

        <button id="startButton">Start Processing</button>
        <audio id="audioPlayer" controls style="display: none">
            <source src="speach2.wav" type="audio/wav" />
            Your browser does not support the audio element.
        </audio>
        <h1 id="mouthCueDisplay"></h1>
        <h1 id="frequency"></h1>
        <h1 id="time"></h1>

        <script>
            document
                .getElementById("startButton")
                .addEventListener("click", () => {
                    fetch("http://localhost:3000/process-audio")
                        .then((response) => response.json())
                        .then((data) => {
                            const mouthCues = data.message;
                            console.log(mouthCues);
                            const audioPlayer =
                                document.getElementById("audioPlayer");
                            audioPlayer.style.display = "block";
                            audioPlayer.play();

                            // Set playback rate for slow motion
                            audioPlayer.playbackRate = 1;

                            const currentTimeClosure = (() => {
                                let currentTime = 0;
                                let isFinished = false;
                                return {
                                    setFinished: () => {
                                        isFinished = true;
                                    },
                                    getCurrentTime: () => currentTime,
                                    setCurrentTime: (time) => {
                                        currentTime = time;
                                    },
                                    getIsFinished: () => isFinished,
                                };
                            })();

                            const interval = setInterval(() => {
                                const currentTime = audioPlayer.currentTime;
                                currentTimeClosure.setCurrentTime(currentTime);

                                if (currentTimeClosure.getIsFinished()) {
                                    clearInterval(interval);
                                }

                                mouthCues.forEach((cue) => {
                                    if (
                                        currentTime >= cue.start &&
                                        currentTime <= cue.end
                                    ) {
                                        document.getElementById(
                                            "mouthCueDisplay"
                                        ).innerText = JSON.stringify(cue.value);
                                        document.getElementById(
                                            "time"
                                        ).innerText = `start: ${cue.start}`;
                                        document.getElementById(
                                            "frequency"
                                        ).innerText = `frequency1: ${cue.frequencies[0]} <br> frequency2: ${cue.frequencies[1]} <br> frequency3: ${cue.frequencies[2]}`;
                                    }
                                });
                            }, 1000 / 60); // Update approximately 60 times per second

                            audioPlayer.addEventListener("ended", () => {
                                clearInterval(interval);
                                currentTimeClosure.setFinished();
                            });

                            audioPlayer.addEventListener("play", () => {
                                currentTimeClosure.setCurrentTime(0);
                            });
                        })
                        .catch((error) => {
                            console.error("Error processing audio:", error);
                        });
                });
        </script>
    </body>
</html>
